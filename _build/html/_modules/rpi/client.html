

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rpi.client &mdash; Yozakura 1.0 RC documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Yozakura 1.0 RC documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> Yozakura
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Hardware and Software Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#environment-setup">Environment setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#ubuntu-setup">Ubuntu setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#raspbian-setup">Raspbian setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#peripherals">Peripherals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#contec">CONTEC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#contec-station-connected-to-base-station">CONTEC station (connected to base station)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#contec-access-point-connected-to-rpi">CONTEC access point (connected to RPi)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#cameras">Cameras</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#ai-ball-access-point-elecom">Ai-Ball access point (elecom)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#camera-ip-addresses">Camera IP addresses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#urg-ust-10lx">URG (UST-10LX)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#wiring">Wiring</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#raspberry-pi">Raspberry Pi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Technical Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../common.html">common package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common.exceptions">common.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common.functions">common.functions module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../opstn.html">opstn package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn.controller">opstn.controller module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn.server">opstn.server module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../rpi.html">rpi package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.bitfields">rpi.bitfields module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.client">rpi.client module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.devices">rpi.devices module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#rpi-mbed-module">rpi.mbed module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.motor">rpi.motor module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Yozakura</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>rpi.client</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for rpi.client</h1><div class="highlight"><pre>
<span class="c"># (C) 2015  Kyoto University Mechatronics Laboratory</span>
<span class="c"># Released under the GNU General Public License, version 3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Communicate with the base station and run the robot.</span>

<span class="sd">The client obtains motor speeds and arm commands from the base station, and</span>
<span class="sd">relays them to the respective mbed.</span>

<span class="sd">If the received speed for a flipper is zero, it attempts to hold the position</span>
<span class="sd">based on potentiometer data received from the body mbed. It also does not allow</span>
<span class="sd">the flipper to move beyond the capabilities of the potentiometer.</span>

<span class="sd">The client also obtains the currents going to individual motors from current</span>
<span class="sd">sensors connected via I2C. In addition, front and rear body pose are returned</span>
<span class="sd">via two I2C-connected IMUs.</span>

<span class="sd">From the arm mbed, the client receives servo positions, voltages, and currents;</span>
<span class="sd">two 4x4 temperature matrices; and readings from a |CO2| sensor attached to the</span>
<span class="sd">arm.</span>

<span class="sd">All external sensor data is sent back to the base station asynchronously via</span>
<span class="sd">UDP.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">common.exceptions</span> <span class="kn">import</span> <span class="n">BadDataError</span><span class="p">,</span> <span class="n">YozakuraTimeoutError</span><span class="p">,</span>\
    <span class="n">NoConnectionError</span><span class="p">,</span> <span class="n">NoMbedError</span><span class="p">,</span> <span class="n">MotorCountError</span><span class="p">,</span> <span class="n">NoDriversError</span>
<span class="kn">from</span> <span class="nn">rpi.motor</span> <span class="kn">import</span> <span class="n">Motor</span>
<span class="kn">from</span> <span class="nn">rpi.bitfields</span> <span class="kn">import</span> <span class="n">ArmPacket</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client to communicate with the base station and control the robot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client_address : str</span>
<span class="sd">        The local IP address of Yozakura.</span>
<span class="sd">    server_address : 2-tuple of (str, int)</span>
<span class="sd">        The address at which the server is listening. The elements are the</span>
<span class="sd">        server IP address and the port number respectively.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NoConnectionError</span>
<span class="sd">        The client cannot connect to the base station.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    request : socket</span>
<span class="sd">        Handles communication with the server.</span>
<span class="sd">    server_address : 2-tuple of (str, int)</span>
<span class="sd">        The address at which the server is listening. The elements are the</span>
<span class="sd">        server IP address and the port number respectively.</span>
<span class="sd">    motors : dict</span>
<span class="sd">        Contains all registered motors.</span>

<span class="sd">        **Dictionary format :** {name (str): motor (Motor)}</span>
<span class="sd">    mbeds : dict</span>
<span class="sd">        Contains all registered serial connections.</span>

<span class="sd">        **Dictionary format :** {name (str): connection (Serial)}</span>
<span class="sd">    current_sensors : dict</span>
<span class="sd">        Contains all registered current sensors.</span>

<span class="sd">        **Dictionary format :** {name (str): sensor (CurrentSensor)}</span>
<span class="sd">    imus : dict</span>
<span class="sd">        Contains all registered IMUs.</span>

<span class="sd">        **Dictionary format :** {name (str): imu (IMU)}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;{ip}_client&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">client_address</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Creating client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConnectionRefusedError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoConnectionError</span><span class="p">(</span><span class="s">&quot;Base station is not connected! &quot;</span> <span class="o">+</span>
                                    <span class="s">&quot;Is the server on?&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoConnectionError</span><span class="p">(</span><span class="s">&quot;Base station is on the wrong network! &quot;</span> <span class="o">+</span>
                                    <span class="s">&quot;Is its IP address is static?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connected to {server}:{port}&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="n">port</span><span class="o">=</span><span class="n">server_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c"># seconds</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_address</span> <span class="o">=</span> <span class="n">server_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensors_server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motors</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sensors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imus</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="Client.add_mbed"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.add_mbed">[docs]</a>    <span class="k">def</span> <span class="nf">add_mbed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an mbed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the device.</span>
<span class="sd">        ser : Mbed</span>
<span class="sd">            The serial connection to the mbed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding {name}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span>
</div>
<div class="viewcode-block" id="Client.add_motor"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.add_motor">[docs]</a>    <span class="k">def</span> <span class="nf">add_motor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pwm_pins</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up and register a motor.</span>

<span class="sd">        This method must be called before `run`. Either `ser` or</span>
<span class="sd">        `pwm_pins` must be provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        motor : Motor</span>
<span class="sd">            The motor to be registered.</span>
<span class="sd">        ser : Serial, optional</span>
<span class="sd">            The serial connection to communicate with the mbed to which the</span>
<span class="sd">            motor drivers are connected. This is needed in order to enable</span>
<span class="sd">            hardware PWM.</span>
<span class="sd">        pwm_pins : 2-tuple of ints, optional</span>
<span class="sd">            The pins used for soft PWM. The elements are the PWM pin and the</span>
<span class="sd">            DIR pin, respectively.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NoDriversError</span>
<span class="sd">            Neither `ser` nor `pwm_pins` have been provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding {name}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">motor</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ser</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pwm_pins</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoDriversError</span><span class="p">(</span><span class="n">motor</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pwm_pins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">motor</span><span class="o">.</span><span class="n">enable_soft_pwm</span><span class="p">(</span><span class="o">*</span><span class="n">pwm_pins</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">motor</span><span class="o">.</span><span class="n">enable_serial</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">motors</span><span class="p">[</span><span class="n">motor</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">motor</span>
</div>
<div class="viewcode-block" id="Client.add_current_sensor"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.add_current_sensor">[docs]</a>    <span class="k">def</span> <span class="nf">add_current_sensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a current sensor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sensor : CurrentSensor</span>
<span class="sd">            The current sensor associated with the motor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding {name}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">sensor</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sensors</span><span class="p">[</span><span class="n">sensor</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor</span>
</div>
<div class="viewcode-block" id="Client.add_imu"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.add_imu">[docs]</a>    <span class="k">def</span> <span class="nf">add_imu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an IMU.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imu : IMU</span>
<span class="sd">            The IMU to be added.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding {name}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">imu</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imus</span><span class="p">[</span><span class="n">imu</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">imu</span>
</div>
<div class="viewcode-block" id="Client.run"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send and handle requests until a `KeyboardInterrupt` is received.</span>

<span class="sd">        This method connects to the server, and loops forever. It takes the</span>
<span class="sd">        speed and arm commands from the base station, and manages the outputs.</span>
<span class="sd">        It attempts to hold the flipper position if there is no input.</span>

<span class="sd">        If the connection is lost, it shuts down the motors as an emergency</span>
<span class="sd">        measure. The motors would continue working if the connection to the</span>
<span class="sd">        base station is re-established.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        MotorCountError</span>
<span class="sd">            There are fewer than four motors registered.</span>
<span class="sd">        NoMbedError</span>
<span class="sd">            The body mbed is not registered, or no mbeds are registered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Insufficient motors registered!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MotorCountError</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motors</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoMbedError</span><span class="p">(</span><span class="s">&quot;No mbeds are registered.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&quot;mbed_body&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoMbedError</span><span class="p">(</span><span class="s">&quot;The body mbed is not registered.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Client started&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">motor_commands</span><span class="p">,</span> <span class="n">arm_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_commands</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">BadDataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_timeout</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">BrokenPipeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Base station turned off!&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NoConnectionError</span><span class="p">(</span><span class="s">&quot;Base station turned off!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received speeds&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connection returned&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="n">flipper_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flipper_positions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drive_motors</span><span class="p">(</span><span class="n">motor_commands</span><span class="p">,</span> <span class="n">flipper_positions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command_arm</span><span class="p">(</span><span class="n">arm_commands</span><span class="p">)</span>

            <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_data</span><span class="p">(</span><span class="s">&quot;left_wheel_current&quot;</span><span class="p">,</span>
                                                  <span class="s">&quot;right_wheel_current&quot;</span><span class="p">,</span>
                                                  <span class="s">&quot;left_flipper_current&quot;</span><span class="p">,</span>
                                                  <span class="s">&quot;right_flipper_current&quot;</span><span class="p">)</span>
            <span class="n">imu_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_imu_data</span><span class="p">(</span><span class="s">&quot;front_imu&quot;</span><span class="p">,</span> <span class="s">&quot;rear_imu&quot;</span><span class="p">)</span>
            <span class="n">arm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arm_data</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_send_data</span><span class="p">(</span><span class="n">flipper_positions</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">imu_data</span><span class="p">,</span> <span class="n">arm_data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_handle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn off motors in case of a lost connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Lost connection to base station&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Turning off motors&quot;</span><span class="p">)</span>
        <span class="n">Motor</span><span class="o">.</span><span class="n">shutdown_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_request_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request speed data from base station.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        motor_commands : 4-list of float</span>
<span class="sd">            A list of the speeds requested of each motor:</span>

<span class="sd">            - Left wheel motor</span>
<span class="sd">            - Right wheel motor</span>
<span class="sd">            - Left flipper motor</span>
<span class="sd">            - Right flipper motor</span>

<span class="sd">        arm_commands : 4-tuple of int</span>
<span class="sd">            A list of commands for the arm servos:</span>

<span class="sd">            - mode</span>
<span class="sd">            - linear</span>
<span class="sd">            - pitch</span>
<span class="sd">            - yaw</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Requesting commands&quot;</span><span class="p">)</span>
        <span class="c"># TODO (murata): Change &quot;speeds&quot; to &quot;commands&quot; in opstn.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;commands&quot;</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadDataError</span><span class="p">(</span><span class="s">&quot;No motor or arm commands received&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">motor_commands</span><span class="p">,</span> <span class="n">arm_commands</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadDataError</span><span class="p">(</span><span class="s">&quot;Invalid motor or arm commands received: {e}&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">motor_commands</span><span class="p">,</span> <span class="n">arm_commands</span>

    <span class="k">def</span> <span class="nf">_drive_motors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_commands</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drive all the motors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        motor_commands : 4-list of float</span>
<span class="sd">            The speeds with which to drive the four motors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Driving motors&quot;</span><span class="p">)</span>
        <span class="c"># Stop when approaching potentiometer limits.</span>
        <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mf">0.05</span> <span class="o">&lt;</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">motor_commands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Left flipper near limit: {pos:5.3f}&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>\
            <span class="ow">and</span> <span class="p">((</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">motor_commands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.95</span> <span class="ow">and</span> <span class="n">motor_commands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Left flipper is near its limit: {pos:5.3f}&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">motor_commands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>\
            <span class="ow">and</span> <span class="p">((</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">motor_commands</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.95</span> <span class="ow">and</span> <span class="n">motor_commands</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Right flipper is near its limit: {pos:5.3f}&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">motor_commands</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">motor</span><span class="p">,</span> <span class="n">speed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motors</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">motor_commands</span><span class="p">):</span>
            <span class="n">motor</span><span class="o">.</span><span class="n">drive</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_command_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Command the arm.</span>

<span class="sd">        Yozakura is capable of running without the arm connected. If the arm is</span>
<span class="sd">        not connected, do not do anything.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commands : 4-tuple of int</span>
<span class="sd">            A list of commands for the arm servos.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Commanding arm&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;mbed_arm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="n">ArmPacket</span><span class="p">()</span>
            <span class="n">packet</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="n">packet</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span>
            <span class="n">packet</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span>
            <span class="n">packet</span><span class="o">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">[</span><span class="s">&quot;mbed_arm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">packet</span><span class="o">.</span><span class="n">as_byte</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_get_flipper_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the flipper positions from the body mbed.</span>

<span class="sd">        The body mbed has six Analog-to-Digital Conversion ports, to which</span>
<span class="sd">        potentiometers attached to the flippers are connected.</span>

<span class="sd">        The positions range from 0 to 1, and represent ten revolutions of the</span>
<span class="sd">        potentiometer.</span>

<span class="sd">        The potentiometers used are XXX. [#]_</span>

<span class="sd">        .. warning:: The left and right flipper change the potentiometer</span>
<span class="sd">                     position in opposite directions for a given change in angle</span>
<span class="sd">                     relative to the body of the robot.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        positions : 2-tuple of float</span>
<span class="sd">            The flipper position data from the mbed, or ``[None, None]`` if</span>
<span class="sd">            invalid data was obtained. The items are:</span>

<span class="sd">            - Left flipper position.</span>
<span class="sd">            - Right flipper position.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [#] XXX The potentiometer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO (masasin): What is the potentiometer used?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Requesting mbed body data&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mbed_body_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">[</span><span class="s">&quot;mbed_body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0xFFFF</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mbed_body_data</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">YozakuraTimeoutError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bad mbed flipper data&quot;</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received mbed body data&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Flipper positions: {pos}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">positions</span>

    <span class="k">def</span> <span class="nf">_get_arm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get transmitted data from the arm mbed.</span>

<span class="sd">        The arm mbed is connected to the servos driving the arm, as well as</span>
<span class="sd">        to two temperature sensors and a CO2 sensor.</span>

<span class="sd">        If bad data is received, or if the mbed is not connected, every value</span>
<span class="sd">        returned will be ``None``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ignore : bool, optional</span>
<span class="sd">            Whether to return empty data without querying the mbed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        positions : 3-list of float</span>
<span class="sd">            The positions of the linear, pitch, and yaw servos respectively.</span>
<span class="sd">        servo_vii : 3-list of float</span>
<span class="sd">            The voltage reading of the linear servo in volts, and the current</span>
<span class="sd">            readings of the pitch and yaw servos in milliamperes.</span>
<span class="sd">        thermo_sensors : 2-list of 16-list of float</span>
<span class="sd">            The temperature matrices of the left and right 4x4 thermal sensors</span>
<span class="sd">            respectively. Units are in degrees Celsius.</span>
<span class="sd">        co2_sensor : float</span>
<span class="sd">            The reading of the carbon dioxide sensor in PPM.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Requesting arm data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="n">float_arm_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">39</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;mbed_arm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;mbed connected&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mbed_arm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">[</span><span class="s">&quot;mbed_arm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbed_arm_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">39</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;Too few items received&quot;</span><span class="p">)</span>
                    <span class="n">float_arm_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mbed_arm_data</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">YozakuraTimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bad mbed sensor data: {e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">float_arm_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">39</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Arm mbed not in mbeds&quot;</span><span class="p">)</span>
                <span class="n">float_arm_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">39</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">float_arm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">servo_vii</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">float_arm_data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]]</span>

        <span class="n">thermo_l</span> <span class="o">=</span> <span class="n">float_arm_data</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span>
        <span class="n">thermo_r</span> <span class="o">=</span> <span class="n">float_arm_data</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span>
        <span class="n">thermo_sensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">thermo_l</span><span class="p">,</span> <span class="n">thermo_r</span><span class="p">]</span>

        <span class="n">co2_sensor</span> <span class="o">=</span> <span class="n">float_arm_data</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Servo positions: {pos}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Servo VII: {vii}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vii</span><span class="o">=</span><span class="n">servo_vii</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Left temperature: {tl}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tl</span><span class="o">=</span><span class="n">thermo_l</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Right temperature: {tr}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="n">thermo_r</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;CO2: {ppm} PPM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ppm</span><span class="o">=</span><span class="n">co2_sensor</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">servo_vii</span><span class="p">,</span> <span class="n">thermo_sensors</span><span class="p">,</span> <span class="n">co2_sensor</span>

    <span class="k">def</span> <span class="nf">_get_current_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">current_sensors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data from the requested current sensors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        current_sensors : list of str</span>
<span class="sd">            A list containing the names of the current sensors to be read.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        current_data : list of 2-list of float</span>
<span class="sd">            A list containing the current (A) and voltage (V) readings of each</span>
<span class="sd">            sensor. If invalid sensor data was obtained, the readings are set to</span>
<span class="sd">            ``[None, None, None]`` by default.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Requesting current data&quot;</span><span class="p">)</span>
        <span class="n">current_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">current_sensors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sensors</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span><span class="o">.</span><span class="n">iv</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bad current sensor data: {e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
                <span class="n">current_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">current_data</span>

    <span class="k">def</span> <span class="nf">_get_imu_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">imus</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data from the requested inertial measurement units.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imus : list of str</span>
<span class="sd">            A list containing the names of the IMUs to be read.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        imu_data : list of 3-list of float</span>
<span class="sd">            A list containing the roll, pitch, and yaw readings of each sensor,</span>
<span class="sd">            in radians. If invalid sensor data was obtained, the readings are</span>
<span class="sd">            set to ``[None, None, None]`` by default.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Getting imu data&quot;</span><span class="p">)</span>
        <span class="n">imu_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">imu</span> <span class="ow">in</span> <span class="n">imus</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imu_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imus</span><span class="p">[</span><span class="n">imu</span><span class="p">]</span><span class="o">.</span><span class="n">rpy</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bad IMU data: {e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
                <span class="n">imu_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;Front IMU data: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imu_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s">&quot; Rear IMU data: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imu_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Got imu data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imu_data</span>

    <span class="k">def</span> <span class="nf">_send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flipper_positions</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">imu_data</span><span class="p">,</span> <span class="n">arm_data</span><span class="p">,</span>
                   <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send data to base station.</span>

<span class="sd">        This method sends data via UDP. UDP is asynchronous, and allows the base</span>
<span class="sd">        station to work at a different rate than the robot, and ignore old data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flipper_positions : 2-list of float</span>
<span class="sd">            The positions of the flippers.</span>
<span class="sd">        current_data : list of 2-list of float</span>
<span class="sd">            The current sensor measurements.</span>
<span class="sd">        imus : list of 3-list of float</span>
<span class="sd">            The IMU measurements.</span>
<span class="sd">        arm_data : list of lists and float</span>
<span class="sd">            The data returned from the arm.</span>
<span class="sd">        protocol : int, optional</span>
<span class="sd">            The protocol to use to pickle the data. The ROS-based base station</span>
<span class="sd">            software uses Python 2, and therefore the maximum usable protocol</span>
<span class="sd">            version is 2. If you are sure that Python 2 will not be</span>
<span class="sd">            used, feel free to use whatever protocol you want.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        _get_arm_data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sending data to base station&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensors_server</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">((</span><span class="n">flipper_positions</span><span class="p">,</span>
                                                  <span class="n">current_data</span><span class="p">,</span>
                                                  <span class="n">imu_data</span><span class="p">,</span>
                                                  <span class="n">arm_data</span><span class="p">),</span>
                                                 <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">server_address</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_last_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the last line from a serial device&#39;s buffer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ser : str</span>
<span class="sd">            The name of the serial device to be read.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The last line from the serial device&#39;s buffer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer_string</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbeds</span><span class="p">[</span><span class="n">ser</span><span class="p">]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">buffer_string</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">buffer_string</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">buffer_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="Client.shutdown"><a class="viewcode-back" href="../../rpi.html#rpi.client.Client.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shut down the client.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Shutting down client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Client shut down&quot;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Kyoto University Mechatronics Laboratory.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0 RC',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>