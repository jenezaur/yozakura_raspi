

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rpi.motor &mdash; Yozakura 1.0 RC documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Yozakura 1.0 RC documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> Yozakura
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Hardware and Software Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#environment-setup">Environment setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#ubuntu-setup">Ubuntu setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#raspbian-setup">Raspbian setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#peripherals">Peripherals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#contec">CONTEC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#contec-station-connected-to-base-station">CONTEC station (connected to base station)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#contec-access-point-connected-to-rpi">CONTEC access point (connected to RPi)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#cameras">Cameras</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#ai-ball-access-point-elecom">Ai-Ball access point (elecom)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#camera-ip-addresses">Camera IP addresses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#urg-ust-10lx">URG (UST-10LX)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../setup.html#wiring">Wiring</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../setup.html#raspberry-pi">Raspberry Pi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Technical Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../common.html">common package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common.exceptions">common.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common.html#module-common.functions">common.functions module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../opstn.html">opstn package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn.controller">opstn.controller module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../opstn.html#module-opstn.server">opstn.server module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../rpi.html">rpi package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi">Module contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.bitfields">rpi.bitfields module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.client">rpi.client module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.devices">rpi.devices module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#rpi-mbed-module">rpi.mbed module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rpi.html#module-rpi.motor">rpi.motor module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Yozakura</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>rpi.motor</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for rpi.motor</h1><div class="highlight"><pre>
<span class="c"># (C) 2015  Kyoto University Mechatronics Laboratory</span>
<span class="c"># Released under the GNU General Public License, version 3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Control the motors on the robot.</span>

<span class="sd">Motors expect at least one control method, which can be either a serial port</span>
<span class="sd">for microcontroller communication, or software PWM. Up to four motors can be</span>
<span class="sd">used.</span>

<span class="sd">The supported motor driver is the Pololu High-Power Motor Driver 18v15. [#]_</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">.. [#] Pololu, High-Power Motor Driver 18v15 datasheet.</span>
<span class="sd">       https://www.pololu.com/product/755</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="nn">RPi</span> <span class="kn">import</span> <span class="n">GPIO</span> <span class="k">as</span> <span class="n">gpio</span>

<span class="kn">from</span> <span class="nn">common.exceptions</span> <span class="kn">import</span> <span class="n">BadArgError</span><span class="p">,</span> <span class="n">MotorCountError</span><span class="p">,</span> <span class="n">NoDriversError</span>
<span class="kn">from</span> <span class="nn">rpi.bitfields</span> <span class="kn">import</span> <span class="n">MotorPacket</span>


<div class="viewcode-block" id="Motor"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor">[docs]</a><span class="k">class</span> <span class="nc">Motor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing the motor drivers used on Yozakura.</span>

<span class="sd">    The motor driver used is the Pololu High-Power Motor Driver 18v15. [#]_</span>

<span class="sd">    After the motor is initialized and registered, at least one control method</span>
<span class="sd">    must be added. These can be either a serial port connected to a</span>
<span class="sd">    microcontroller for hardware PWM, or software PWM. If hardware PWM is used,</span>
<span class="sd">    the software PWM will be ignored.</span>

<span class="sd">    Up to four motors can be registered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the motor.</span>
<span class="sd">    fault_1 : int</span>
<span class="sd">        GPIO pin for the motor Fault line, FF1.</span>
<span class="sd">    fault_2 : int</span>
<span class="sd">        GPIO pin for the motor Fault line, FF2.</span>
<span class="sd">    reset : int</span>
<span class="sd">        GPIO pin for resetting the motor driver.</span>
<span class="sd">    start_input : float, optional</span>
<span class="sd">        The input at which the motor starts responding. The output will be</span>
<span class="sd">        scaled between that value and one. For instance, if the motors do not</span>
<span class="sd">        turn until the input is at 20%, an input of 10% would be scaled up to</span>
<span class="sd">        28%, and 50% would be scaled up to 60%. Can range between 0 and 1.</span>
<span class="sd">    max_speed : float, optional</span>
<span class="sd">        The maximum speed to use with the motor. Can range between 0 and 1.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    BadArgError</span>
<span class="sd">        Bad inputs are made.</span>
<span class="sd">    MotorCountError</span>
<span class="sd">        A motor is added after all four motors have already been registered.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the motor.</span>
<span class="sd">    motor_id : int</span>
<span class="sd">        The motor ID. It is generated automatically.</span>
<span class="sd">    pin_fault_1 : int</span>
<span class="sd">        The GPIO pin for the motor Fault line, FF1.</span>
<span class="sd">    pin_fault_2 : int</span>
<span class="sd">        The GPIO pin for the motor Fault line, FF2.</span>
<span class="sd">    pin_reset : int</span>
<span class="sd">        GPIO pin for resetting the motor driver.</span>
<span class="sd">    has_serial : bool</span>
<span class="sd">        Whether a serial port is open, and hardware PWM is available.</span>
<span class="sd">    has_pwm : bool</span>
<span class="sd">        Whether software PWM is available.</span>
<span class="sd">    ser : Serial</span>
<span class="sd">        The serial port to be used for communication.</span>
<span class="sd">    pin_pwm : int</span>
<span class="sd">        The GPIO pin for motor PWM line.</span>
<span class="sd">    pin_dir : int</span>
<span class="sd">        The GPIO pin for motor DIR line.</span>
<span class="sd">    start_input : float</span>
<span class="sd">        The input at which the motor starts responding.</span>
<span class="sd">    max_speed : float</span>
<span class="sd">        The maximum speed at which to run the motor.</span>
<span class="sd">    motors : list</span>
<span class="sd">        Contains all registered motors.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [#] Pololu, High-Power Motor Driver 18v15 datasheet.</span>
<span class="sd">           https://www.pololu.com/product/755</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gpio</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">gpio</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>
    <span class="n">gpio</span><span class="o">.</span><span class="n">setwarnings</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># No warning when using the same pin for reset bus.</span>
    <span class="n">motors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fault_1</span><span class="p">,</span> <span class="n">fault_2</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span>
                 <span class="n">start_input</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_speed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Motor</span><span class="o">.</span><span class="n">_count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MotorCountError</span><span class="p">(</span><span class="n">Motor</span><span class="o">.</span><span class="n">_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">start_input</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadArgError</span><span class="p">(</span><span class="s">&quot;`start_input` should be between 0 and 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">max_speed</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadArgError</span><span class="p">(</span><span class="s">&quot;`max_speed` should be between 0 and 1.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initializing motor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_id</span> <span class="o">=</span> <span class="n">Motor</span><span class="o">.</span><span class="n">_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_1</span> <span class="o">=</span> <span class="n">fault_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_2</span> <span class="o">=</span> <span class="n">fault_2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_reset</span> <span class="o">=</span> <span class="n">reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_input</span> <span class="o">=</span> <span class="n">start_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">max_speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_serial</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_pwm</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Setting up fault interrupt&quot;</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">fault_1</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull_up_down</span><span class="o">=</span><span class="n">gpio</span><span class="o">.</span><span class="n">PUD_DOWN</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">fault_2</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull_up_down</span><span class="o">=</span><span class="n">gpio</span><span class="o">.</span><span class="n">PUD_DOWN</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">add_event_detect</span><span class="p">(</span><span class="n">fault_1</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">RISING</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_catch_fault</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">add_event_detect</span><span class="p">(</span><span class="n">fault_2</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">RISING</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_catch_fault</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Resetting motor driver&quot;</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_driver</span><span class="p">()</span>  <span class="c"># Clear any startup faults.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Registering motor&quot;</span><span class="p">)</span>
        <span class="n">Motor</span><span class="o">.</span><span class="n">motors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Motor initialized&quot;</span><span class="p">)</span>
        <span class="n">Motor</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_catch_fault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Threaded callback for fault detection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Undervolt detected!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Overtemp detected!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_fault_2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Short detected!&quot;</span><span class="p">)</span>
            <span class="c"># Uncomment the following lines if you want to not stop at shorts.</span>
            <span class="c"># for motor in Motor.motors:</span>
            <span class="c">#     motor.reset_driver()</span>

<div class="viewcode-block" id="Motor.enable_serial"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.enable_serial">[docs]</a>    <span class="k">def</span> <span class="nf">enable_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow the use of a USB serial connection.</span>

<span class="sd">        If it is enabled, speed commands will be sent to an external</span>
<span class="sd">        microcontroller, such as an mbed, which will output the PWM signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ser : Serial</span>
<span class="sd">            Communicates with the external hardware.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_serial</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Motor.enable_soft_pwm"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.enable_soft_pwm">[docs]</a>    <span class="k">def</span> <span class="nf">enable_soft_pwm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwm</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">28000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow software PWM to control the motor.</span>

<span class="sd">        The motor in this case needs to be attached directly to the rpi. If</span>
<span class="sd">        serial is also enabled, serial takes priority and software PWM is not</span>
<span class="sd">        used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pwm : int</span>
<span class="sd">            The GPIO pin for the motor driver&#39;s PWM line.</span>
<span class="sd">        direction : int</span>
<span class="sd">            The GPIO pin for the motor driver&#39;s DIR line.</span>
<span class="sd">        frequency : float, optional</span>
<span class="sd">            The frequency of the software PWM.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_pwm</span> <span class="o">=</span> <span class="n">pwm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_dir</span> <span class="o">=</span> <span class="n">direction</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Setting up GPIO pins&quot;</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_pwm</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting PWM drivers&quot;</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwm</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">PWM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_pwm</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwm</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">has_pwm</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Motor.drive"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.drive">[docs]</a>    <span class="k">def</span> <span class="nf">drive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drive the motor at a given speed.</span>

<span class="sd">        The priority goes to the microcontroller if serial is enabled. Software</span>
<span class="sd">        PWM is used if serial is not enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            A value from -1 to 1 indicating the requested speed.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NoDriversError</span>
<span class="sd">            Neither serial nor PWM are enabled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_serial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transmit</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_pwm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pwm_drive</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoDriversError</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_scale_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the scaled speed according to input parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            A value from -1 to 1 indicating the requested speed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The scaled speed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Map [start_input:1] to [0:1]</span>
        <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scaled_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_input</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_input</span>
        <span class="k">elif</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scaled_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_input</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaled_speed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Map [0:1] to [0:max_speed]</span>
        <span class="n">scaled_speed</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">scaled_speed</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a byte through a serial connection.</span>

<span class="sd">        When connected to the mbed, motor control information is encoded as a</span>
<span class="sd">        single byte, with the first two bits encoding the motor&#39;s ID, and the</span>
<span class="sd">        next bit encoding the sign. The last five bits encode the absolute</span>
<span class="sd">        value of the speed to a number between 0 and 31.</span>

<span class="sd">        This allows only the relevant information to be transmitted, and also</span>
<span class="sd">        lets the mbed perform asynchronously.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            A value from -1 to 1 indicating the requested speed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">MotorPacket</span><span class="p">()</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">motor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_id</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">negative</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span> <span class="o">*</span> <span class="mi">31</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">packet</span><span class="o">.</span><span class="n">as_byte</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_pwm_drive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drive the motor using software PWM.</span>

<span class="sd">        The PWM signal goes to the motor driver&#39;s PWM pin. DIR is set depending</span>
<span class="sd">        on the speed requested.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            A value from -1 to 1 indicating the requested speed of the motor.</span>
<span class="sd">            The speed is changed by changing the PWM duty cycle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scaled_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>

        <span class="n">gpio</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">LOW</span> <span class="k">if</span> <span class="n">scaled_speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">gpio</span><span class="o">.</span><span class="n">HIGH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwm</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scaled_speed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

<div class="viewcode-block" id="Motor.reset_driver"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.reset_driver">[docs]</a>    <span class="k">def</span> <span class="nf">reset_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the motor driver.&quot;&quot;&quot;</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_reset</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_reset</span><span class="p">,</span> <span class="n">gpio</span><span class="o">.</span><span class="n">HIGH</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Motor.shutdown"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shut down the motor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Shutting down motor&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drive</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoDriversError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;No drivers available&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Motor shut down&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Motor.shutdown_all"><a class="viewcode-back" href="../../rpi.html#rpi.motor.Motor.shutdown_all">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown_all</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shut down all motors.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Shutting down all motors&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">motors</span><span class="p">:</span>
            <span class="n">motor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">gpio</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;All motors shut down&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;{name} (ID# {m_id})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">m_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Kyoto University Mechatronics Laboratory.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0 RC',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>